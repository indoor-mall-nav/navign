name: CI

on:
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]

env:
  CARGO_TERM_COLOR: always

jobs:
  # Detect which components changed and create dynamic matrix
  detect-changes:
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}
      should-run: ${{ steps.set-matrix.outputs.should-run }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Detect changed components
        id: set-matrix
        run: |
          # Fetch base branch
          git fetch origin ${{ github.base_ref || 'main' }}

          # Get list of modified files
          CHANGED_FILES=$(git diff --name-only origin/${{ github.base_ref || 'main' }}...HEAD || echo "")

          if [ -z "$CHANGED_FILES" ]; then
            echo "No files modified. Skipping CI."
            echo "should-run=false" >> $GITHUB_OUTPUT
            echo 'matrix={"component":[]}' >> $GITHUB_OUTPUT
            exit 0
          fi

          echo "Modified files:"
          echo "$CHANGED_FILES"
          echo ""

          # Initialize component array
          components=()

          # Flags to track what needs to run
          run_shared=false
          run_server=false
          run_firmware=false
          run_mobile=false
          run_admin=false
          run_proc_macros=false
          run_repo=false
          run_robot=false

          # Check which components are affected
          while IFS= read -r file; do
            case "$file" in
              shared/*)
                run_shared=true
                # If shared is modified, run all Rust CI
                run_server=true
                run_firmware=true
                run_admin=true
                run_mobile=true
                ;;
              server/*)
                run_server=true
                ;;
              firmware/*)
                run_firmware=true
                ;;
              mobile/*)
                run_mobile=true
                ;;
              admin/*)
                # Proto files affect all admin components
                run_admin=true
                ;;
              proc_macros/*)
                run_proc_macros=true
                ;;
              robot/*)
                run_robot=true
                ;;
              # Root-level language config file changes (workspace-wide)
              Cargo.lock|rust-toolchain.toml)
                # Workspace Rust config changes → Run all Rust CI
                run_shared=true
                run_server=true
                run_firmware=true
                run_admin=true
                run_mobile=true
                run_proc_macros=true
                run_robot=true
                ;;
              go.work|go.work.sum)
                # Workspace Go config changes → Run admin (tower)
                run_admin=true
                ;;
              pnpm-workspace.yaml|pnpm-lock.yaml|.node-version)
                # Workspace Node config changes → Run mobile
                run_mobile=true
                ;;
              justfile|*.md|.github/*|deny.toml|.typos.toml)
                run_repo=true
                ;;
              ts-schema/*)
                run_mobile=true
                ;;
            esac
          done <<< "$CHANGED_FILES"

          # Build component array. The `repo` lint is tricky and is disabled for now.
          # [ "$run_repo" = true ] && components+=("repo")
          [ "$run_shared" = true ] && components+=("shared")
          [ "$run_server" = true ] && components+=("server")
          [ "$run_firmware" = true ] && components+=("firmware")
          [ "$run_mobile" = true ] && components+=("mobile")
          [ "$run_admin" = true ] && components+=("admin")
          [ "$run_proc_macros" = true ] && components+=("proc-macros")
          [ "$run_robot" = true ] && components+=("robot")

          if [ ${#components[@]} -eq 0 ]; then
            echo "No CI tasks needed for these changes."
            echo "should-run=false" >> $GITHUB_OUTPUT
            echo 'matrix={"component":[]}' >> $GITHUB_OUTPUT
          else
            echo "Components to test: ${components[@]}"
            # Convert bash array to JSON array
            json_array=$(printf '%s\n' "${components[@]}" | jq -R . | jq -s -c '{component: .}')
            echo "matrix=$json_array" >> $GITHUB_OUTPUT
            echo "should-run=true" >> $GITHUB_OUTPUT
          fi

  # Run CI for each affected component in parallel
  ci:
    needs: detect-changes
    if: needs.detect-changes.outputs.should-run == 'true'
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix: ${{ fromJson(needs.detect-changes.outputs.matrix) }}

    steps:
      - uses: actions/checkout@v4

      - name: Setup just
        uses: extractions/setup-just@v3

      # Repo-specific setup
      - name: Setup Taplo
        if: matrix.component == 'repo'
        uses: uncenter/setup-taplo@v1.0.8

      - name: Setup Typos
        if: matrix.component == 'repo'
        uses: crate-ci/typos@v1.39.0

      - name: Install RISC-V target
        if: matrix.component == 'firmware'
        run: rustup target add riscv32imc-unknown-none-elf

      # QEMU simulation tests are available via `just test-firmware-qemu` for manual testing
      # Disabled in CI due to espup installation issues

      # Server-specific setup
      - name: Start MongoDB
        if: matrix.component == 'server'
        uses: supercharge/mongodb-github-action@1.12.0
        with:
          mongodb-version: '8.0'

      # Mobile-specific setup
      - name: Install pnpm
        if: matrix.component == 'mobile'
        uses: pnpm/action-setup@v4
        with:
          version: '10.20.0'

      - name: Use Node.js
        if: matrix.component == 'mobile'
        uses: actions/setup-node@v4
        with:
          node-version: '24.11.1'
          cache: "pnpm"

      - name: Install Tauri dependencies
        if: matrix.component == 'mobile'
        run: |
          sudo apt-get update &&
          sudo apt-get install -y \
          libwebkit2gtk-4.1-dev \
          libayatana-appindicator3-dev \
          webkit2gtk-driver \
          xvfb

      # Tower-specific setup
      - name: Setup Go
        if: matrix.component == 'tower'
        uses: actions/setup-go@v5
        with:
          go-version: '1.25.4'
          cache-dependency-path: go.work.sum

      # Protobuf compiler setup (needed for admin and robot components)
      - name: Install Protobuf Compiler
        if: matrix.component == 'admin' || matrix.component == 'robot'
        run: |
          sudo apt-get update
          sudo apt-get install -y protobuf-compiler

      - name: Install Robot dependencies
        if: matrix.component == 'robot'
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            libopencv-dev \
            libapriltag-dev \
            libprotobuf-dev \
            protobuf-compiler \
            portaudio19-dev \
            apt-file \
            libsdl-image1.2-dev \
            libsdl-mixer1.2-dev \
            libsdl-ttf2.0-dev \
            libsdl1.2-dev \
            libsmpeg-dev \
            subversion \
            libportmidi-dev \
            ffmpeg \
            libswscale-dev \
            libavformat-dev \
            libavcodec-dev \
            libfreetype6-dev

      # Plot-specific setup
      - name: Setup Python
        if: matrix.component == 'admin' || matrix.component == 'robot'
        uses: actions/setup-python@v5
        with:
          python-version: '3.14'

      - name: Install uv
        if: matrix.component == 'admin' || matrix.component == 'robot'
        uses: astral-sh/setup-uv@v5
        with:
          version: "latest"
          enable-cache: true
          cache-dependency-glob: "admin/plot/uv.lock"

      - name: Install ARM target
        if: matrix.component == 'robot'
        run: rustup target add thumbv7em-none-eabi

      # Robot Upper-specific setup (placeholder - not yet implemented)

      # Run the specific CI task
      - name: Run CI for ${{ matrix.component }}
        run: just ci-${{ matrix.component }}
